name: Infinite 4h10m Scheduler

on:
  workflow_dispatch:
  repository_dispatch:
    types: [start-next-scheduled]

permissions:
  contents: read
  actions: write

jobs:
  schedule-chain:
    runs-on: ubuntu-latest

    steps:
      - name: 🕓 Start new scheduled cycle
        run: echo "Starting new scheduled cycle at $(date)"

      # 🔹 (Tutaj możesz uruchomić np. Codespace, Wings itd.)
      - name: 🧠 Example action
        run: |
          echo "Doing work..."
          sleep 10
          echo "Work finished at $(date)"

      # 🔹 Utwórz nowy „scheduled” po 4h10m
      - name: ⏱ Schedule next workflow in 4h10m
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Waiting 4h10m before scheduling next..."
          sleep $((4*3600 + 10*60))
          echo "Triggering next scheduled run..."
          curl -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO/dispatches \
            -d '{"event_type": "start-next-scheduled"}'
          echo "✅ Next scheduled run created at $(date)"

      - name: 🏁 Done
        run: echo "Current scheduled workflow finished at $(date)"
